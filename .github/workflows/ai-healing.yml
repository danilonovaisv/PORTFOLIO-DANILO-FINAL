# AI Self-Healing Agent Workflow
# Automatically analyzes deployment failures and suggests fixes
# Triggered when Firebase deploy workflows fail
#
# HOW TO USE:
# - This workflow runs automatically when a deploy fails
# - You can also trigger it manually via workflow_dispatch
# - Creates a GitHub issue with AI-generated fix suggestions

name: üõ°Ô∏è AI Self-Healing Agent

on:
  workflow_run:
    workflows:
      - Firebase Hosting Merge
      - Firebase Hosting PR Preview
    types:
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID to analyze'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'failure' }}

    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîç Get error logs
        id: get_logs
        run: |
          RUN_ID="${{ github.event.inputs.run_id || github.event.workflow_run.id }}"
          if [ -n "$RUN_ID" ]; then
            gh run view "$RUN_ID" --log-failed > error_logs.txt || echo "No failed logs found" > error_logs.txt
          else
            echo "No workflow run ID available" > error_logs.txt
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: ü§ñ Gemini AI Analysis
        id: gemini_analysis
        uses: google-github-actions/run-gemini-cli@v0.1.18
        with:
          api-key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            Analyze these error logs from a Next.js project with Three.js and Firebase Hosting:
            $(cat error_logs.txt)

            The error occurred during the deploy workflow.
            Check the files next.config.mjs and firebase.json.
            Explain what failed and provide corrected code.
          files: |
            error_logs.txt
            next.config.mjs
            firebase.json

      - name: üõ†Ô∏è Create fix suggestion issue
        if: always()
        run: |
          gh issue create \
            --title "ü§ñ Auto-fix Suggestion: Deploy Failure" \
            --body "AI analyzed the logs and suggests the following changes: \n\n ${{ steps.gemini_analysis.outputs.response }}"
        env:
          GH_TOKEN: ${{ github.token }}
