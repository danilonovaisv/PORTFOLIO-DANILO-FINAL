{"file":"/Users/danilonovais/_danilonov_portfolio/src/lib/supabase/urls.ts","mappings":"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","names":[],"sources":["/Users/danilonovais/_danilonov_portfolio/src/lib/supabase/urls.ts"],"sourcesContent":["const normalizeUrl = (value: string) => value.replace(/\\/+$/, '');\n// Fallback alinhado ao projeto Ghost Era (umkmwbkwvulxtdodzmzf)\nconst DEFAULT_SUPABASE_URL = 'https://umkmwbkwvulxtdodzmzf.supabase.co';\n\nexport function getSupabaseBaseUrl(): string | null {\n  const url =\n    process.env.NEXT_PUBLIC_SUPABASE_URL ??\n    process.env.SUPABASE_URL ??\n    process.env.NEXT_PUBLIC_SUPABASE_URL ??\n    DEFAULT_SUPABASE_URL;\n\n  if (!url) return null;\n  try {\n    return normalizeUrl(url);\n  } catch {\n    return url;\n  }\n}\n\nexport function normalizeStoragePath(\n  filePath?: string | null,\n  bucket?: string\n): string | null {\n  if (!filePath) return null;\n\n  const bucketPrefix = bucket?.replace(/^\\/+|\\/+$/g, '');\n\n  // Remove full Supabase URL prefix if present (object or render endpoints)\n  let normalized = filePath.trim();\n\n  // Clean common malformed prefixes/suffixes from backups (e.g. \"file_path: ...,\" or quoted values)\n  normalized = normalized.replace(/^file_path:\\s*/i, '');\n  normalized = normalized.replace(/^key:\\s*/i, '');\n  normalized = normalized.replace(/^\"+|\"+$/g, '');\n  normalized = normalized.replace(/^'+|'+$/g, '');\n  normalized = normalized.replace(/,+$/g, '');\n  normalized = normalized.replace(/\\s+$/g, '');\n\n  normalized = normalized.replace(\n    /^https?:\\/\\/[^/]+\\/storage\\/v1\\/(?:render\\/image|object)\\/public\\//,\n    ''\n  );\n\n  // Remove local /storage/v1/object/public prefix if the path was stored like that\n  normalized = normalized.replace(\n    /^\\/?storage\\/v1\\/(?:render\\/image|object)\\/public\\//,\n    ''\n  );\n\n  normalized = normalized.replace(/^\\/+/, '');\n\n  if (bucketPrefix && normalized.startsWith(`${bucketPrefix}/`)) {\n    normalized = normalized.slice(bucketPrefix.length + 1);\n  }\n\n  return normalized;\n}\n\nexport function buildSupabaseStorageUrl(\n  bucket: string,\n  filePath?: string | null\n): string | null {\n  if (!filePath) return null;\n\n  const isHttp =\n    filePath.startsWith('http://') || filePath.startsWith('https://');\n  const isSupabaseUrl = filePath.includes('/storage/v1/');\n\n  // Verifica se é uma URL externa não-Supabase\n  if (isHttp && !isSupabaseUrl) {\n    // Validação de segurança para URLs externas\n    try {\n      const url = new URL(filePath);\n      // Permitir apenas protocolos seguros\n      if (url.protocol !== 'https:') {\n        console.warn(`Protocolo inseguro detectado: ${filePath}`);\n        return null;\n      }\n      // Aqui poderíamos adicionar validação de domínio se necessário\n      return filePath;\n    } catch {\n      console.error(`URL inválida: ${filePath}`);\n      return null;\n    }\n  }\n\n  const cleanBucket = bucket.replace(/^\\/+|\\/+$/g, '');\n  const normalizedPath = normalizeStoragePath(filePath, cleanBucket);\n  if (!normalizedPath) {\n    return filePath.startsWith('http') ? filePath : null;\n  }\n\n  // Preserva a origem caso o caminho já seja uma URL completa de outro projeto Supabase\n  if (isHttp && isSupabaseUrl) {\n    try {\n      const url = new URL(filePath);\n      const baseOrigin = `${url.protocol}//${url.host}`;\n      return `${baseOrigin}/storage/v1/object/public/${cleanBucket}/${normalizedPath}`;\n    } catch {\n      // se falhar, segue fluxo padrão\n    }\n  }\n\n  const baseUrl = getSupabaseBaseUrl();\n  if (!baseUrl) {\n    return filePath.startsWith('http') ? filePath : null;\n  }\n\n  return `${baseUrl}/storage/v1/object/public/${cleanBucket}/${normalizedPath}`;\n}\n\n// Função adicional para validar e construir URLs de links externos\nexport function validateExternalUrl(url: string): string | null {\n  if (!url) return null;\n  const normalized = url.trim();\n  if (!normalized) return null;\n\n  const allowedProtocols = ['https:', 'http:'];\n\n  try {\n    const parsedUrl = new URL(normalized);\n    if (allowedProtocols.includes(parsedUrl.protocol)) {\n      return parsedUrl.toString();\n    }\n\n    console.warn(`Link externo inseguro bloqueado: ${url}`);\n    return null;\n  } catch {\n    if (normalized.startsWith('/') || normalized.startsWith('#')) {\n      return normalized;\n    }\n\n    if (normalized.startsWith('//')) {\n      try {\n        const parsedFallback = new URL(`https:${normalized}`);\n        return parsedFallback.toString();\n      } catch {\n        console.error(`URL externa inválida: ${url}`);\n        return null;\n      }\n    }\n\n    console.error(`URL externa inválida: ${url}`);\n    return null;\n  }\n}\n"],"version":3}