c3225010fef2afb7aa08e7dde1ef065c
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.normalizeAssetRecord = normalizeAssetRecord;
exports.normalizeAssetList = normalizeAssetList;
const urls_1 = require("@/lib/supabase/urls");
function normalizeAssetRecord(asset) {
    const cleanBucket = (asset.bucket || 'site-assets')
        .replace(/^bucket:\s*/i, '')
        .replace(/^"+|"+$/g, '')
        .replace(/^'+|'+$/g, '')
        .replace(/^\/+|\/+$/g, '');
    const cleanKey = asset.key
        ?.replace(/^key:\s*/i, '')
        .replace(/^"+|"+$/g, '')
        .replace(/^'+|'+$/g, '')
        .replace(/,+$/g, '')
        .trim();
    const cleanPath = (0, urls_1.normalizeStoragePath)(asset.file_path, cleanBucket);
    const fixClientsPath = (path) => {
        if (!path)
            return path;
        // Casos importados com prefixo duplicado "clients.clients.strip.X.svg"
        if (/^clients\.clients\.strip\./.test(path)) {
            return path.replace(/^clients\.clients\.strip\./, 'clients/clients.strip.');
        }
        if (/^clients\.strip\./.test(path)) {
            return path.replace(/^clients\.strip\./, 'clients/clients.strip.');
        }
        return path;
    };
    const resolvedPath = fixClientsPath(cleanPath);
    // Corrige bucket para media de portfÃ³lio que foram importadas com o bucket errado
    const resolvedBucket = cleanBucket === 'site-assets' && resolvedPath?.startsWith('projects/')
        ? 'portfolio-media'
        : cleanBucket;
    const inferPageFromValue = (value) => {
        if (!value)
            return undefined;
        const trimmed = value
            .replace(/^page:\s*/i, '')
            .replace(/^"+|"+$/g, '')
            .replace(/^'+|'+$/g, '')
            .replace(/,+$/g, '')
            .trim();
        if (!trimmed)
            return undefined;
        if (/^updated_at:/i.test(trimmed) || /^key:/i.test(trimmed))
            return undefined;
        const delimiter = trimmed.includes('/') ? '/' : '.';
        const base = trimmed.split(delimiter)[0];
        return base?.toLowerCase();
    };
    const resolvedPage = inferPageFromValue(asset.page) ||
        inferPageFromValue(resolvedPath) ||
        inferPageFromValue(cleanKey) ||
        'global';
    const publicUrl = (0, urls_1.buildSupabaseStorageUrl)(resolvedBucket, resolvedPath) ||
        (asset.file_path?.startsWith('http') ? asset.file_path : '') ||
        '';
    // Processar href se existir
    let processedAsset = {
        ...asset,
        key: cleanKey ?? asset.key,
        bucket: resolvedBucket,
        file_path: cleanPath ?? '',
        page: resolvedPage,
        resolvedPage,
        publicUrl,
    };
    if (asset.href) {
        const validatedHref = (0, urls_1.validateExternalUrl)(asset.href);
        if (validatedHref) {
            processedAsset = {
                ...processedAsset,
                href: validatedHref,
            };
        }
    }
    return processedAsset;
}
function normalizeAssetList(assets, options = {}) {
    const { onlyActive = false, dropInvalid = true } = options;
    const normalizedByKey = new Map();
    const normalizedByPath = new Map();
    const isInvalidValue = (value) => {
        if (!value)
            return true;
        const normalizedValue = value.trim().toLowerCase();
        if (!normalizedValue)
            return true;
        return (normalizedValue.startsWith('updated_at:') ||
            normalizedValue.startsWith('key:') ||
            normalizedValue.startsWith('file_path:') ||
            normalizedValue === '.keep' ||
            normalizedValue === '.emptyfolderplaceholder');
    };
    const dedupeDoublePrefix = (value) => {
        if (!value)
            return value;
        const trimmed = value.trim();
        if (!trimmed)
            return value;
        const delimiter = trimmed.includes('/') ? '/' : '.';
        const parts = trimmed.split(delimiter).filter(Boolean);
        if (parts.length < 4)
            return value;
        const maxPrefix = Math.min(3, Math.floor(parts.length / 2));
        for (let len = 1; len <= maxPrefix; len++) {
            const first = parts.slice(0, len).join('|').toLowerCase();
            const second = parts
                .slice(len, len * 2)
                .join('|')
                .toLowerCase();
            if (first === second) {
                const deduped = [...parts.slice(0, len), ...parts.slice(len * 2)];
                return deduped.join(delimiter);
            }
        }
        return value;
    };
    const scoreRecord = (record) => {
        const activeScore = record.is_active ? 4 : 0;
        const urlScore = record.publicUrl ? 2 : 0;
        const pathScore = record.file_path?.includes('/') ? 1 : 0;
        const lengthPenalty = Math.min(record.key?.length ?? 0, 60) * 0.01;
        return activeScore + urlScore + pathScore - lengthPenalty;
    };
    for (const asset of assets) {
        const cleanedAsset = {
            ...asset,
            key: dedupeDoublePrefix(asset.key) ?? asset.key,
            file_path: dedupeDoublePrefix(asset.file_path) ?? asset.file_path,
        };
        const record = normalizeAssetRecord(cleanedAsset);
        const key = record.key?.trim();
        if (!key)
            continue;
        if (dropInvalid) {
            if (isInvalidValue(key) || isInvalidValue(record.file_path))
                continue;
        }
        if (onlyActive && !record.is_active)
            continue;
        const hasUsableUrl = Boolean(record.publicUrl || record.asset_type === 'font' || record.href);
        if (dropInvalid && !hasUsableUrl)
            continue;
        const decide = (current, next) => {
            if (!current)
                return next;
            const currentScore = scoreRecord(current);
            const nextScore = scoreRecord(next);
            if (nextScore > currentScore)
                return next;
            if (nextScore === currentScore) {
                return next.key.length < current.key.length ? next : current;
            }
            return current;
        };
        const bestByKey = decide(normalizedByKey.get(key), record);
        normalizedByKey.set(key, bestByKey);
        const pathKey = record.file_path || '';
        if (pathKey) {
            const bestByPath = decide(normalizedByPath.get(pathKey), record);
            normalizedByPath.set(pathKey, bestByPath);
        }
    }
    const merged = new Map();
    for (const item of normalizedByKey.values()) {
        merged.set(item.id, item);
    }
    for (const item of normalizedByPath.values()) {
        merged.set(item.id, item);
    }
    return Array.from(merged.values()).sort((a, b) => {
        const pageA = a.page ?? '';
        const pageB = b.page ?? '';
        if (pageA === pageB) {
            const orderA = a.sort_order ?? Number.MAX_SAFE_INTEGER;
            const orderB = b.sort_order ?? Number.MAX_SAFE_INTEGER;
            if (orderA === orderB)
                return a.key.localeCompare(b.key);
            return orderA - orderB;
        }
        return pageA.localeCompare(pageB);
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rhbmlsb25vdmFpcy9fZGFuaWxvbm92X3BvcnRmb2xpby9zcmMvbGliL3N1cGFiYXNlL3NpdGUtYXNzZXQtdXRpbHMudHMiLCJtYXBwaW5ncyI6Ijs7QUFhQSxvREFzRkM7QUFFRCxnREFzSEM7QUExTkQsOENBSTZCO0FBUTdCLFNBQWdCLG9CQUFvQixDQUFDLEtBQWM7SUFDakQsTUFBTSxXQUFXLEdBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxJQUFJLGFBQWEsQ0FBWTtTQUM1RCxPQUFPLENBQUMsY0FBYyxFQUFFLEVBQUUsQ0FBQztTQUMzQixPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQztTQUN2QixPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQztTQUN2QixPQUFPLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBRTdCLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxHQUFHO1FBQ3hCLEVBQUUsT0FBTyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUM7U0FDekIsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUM7U0FDdkIsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUM7U0FDdkIsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUM7U0FDbkIsSUFBSSxFQUFFLENBQUM7SUFFVixNQUFNLFNBQVMsR0FBRyxJQUFBLDJCQUFvQixFQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDckUsTUFBTSxjQUFjLEdBQUcsQ0FBQyxJQUFvQixFQUFFLEVBQUU7UUFDOUMsSUFBSSxDQUFDLElBQUk7WUFBRSxPQUFPLElBQUksQ0FBQztRQUN2Qix1RUFBdUU7UUFDdkUsSUFBSSw0QkFBNEIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUM1QyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQ2pCLDRCQUE0QixFQUM1Qix3QkFBd0IsQ0FDekIsQ0FBQztRQUNKLENBQUM7UUFDRCxJQUFJLG1CQUFtQixDQUFDLElBQUks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QUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUNELEtBQUssTUFBTSxJQUFJLElBQUksZ0JBQWdCLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQztRQUM3QyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDL0MsTUFBTSxLQUFLLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7UUFDM0IsTUFBTSxLQUFLLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7UUFDM0IsSUFBSSxLQUFLLEtBQUssS0FBSyxFQUFFLENBQUM7WUFDcEIsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLFVBQVUsSUFBSSxNQUFNLENBQUMsZ0JBQWdCLENBQUM7WUFDdkQsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLFVBQVUsSUFBSSxNQUFNLENBQUMsZ0JBQWdCLENBQUM7WUFDdkQsSUFBSSxNQUFNLEtBQUssTUFBTTtnQkFBRSxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN6RCxPQUFPLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDekIsQ0FBQztRQUNELE9BQU8sS0FBSyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNwQyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2Rhbmlsb25vdmFpcy9fZGFuaWxvbm92X3BvcnRmb2xpby9zcmMvbGliL3N1cGFiYXNlL3NpdGUtYXNzZXQtdXRpbHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBEYkFzc2V0IH0gZnJvbSAnQC90eXBlcy9hZG1pbic7XG5pbXBvcnQge1xuICBidWlsZFN1cGFiYXNlU3RvcmFnZVVybCxcbiAgbm9ybWFsaXplU3RvcmFnZVBhdGgsXG4gIHZhbGlkYXRlRXh0ZXJuYWxVcmwsXG59IGZyb20gJ0AvbGliL3N1cGFiYXNlL3VybHMnO1xuXG5leHBvcnQgdHlwZSBOb3JtYWxpemVkU2l0ZUFzc2V0ID0gRGJBc3NldCAmIHtcbiAgcHVibGljVXJsOiBzdHJpbmc7XG4gIGhyZWY/OiBzdHJpbmcgfCBudWxsO1xuICByZXNvbHZlZFBhZ2U6IHN0cmluZztcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVBc3NldFJlY29yZChhc3NldDogRGJBc3NldCk6IE5vcm1hbGl6ZWRTaXRlQXNzZXQge1xuICBjb25zdCBjbGVhbkJ1Y2tldCA9ICgoYXNzZXQuYnVja2V0IHx8ICdzaXRlLWFzc2V0cycpIGFzIHN0cmluZylcbiAgICAucmVwbGFjZSgvXmJ1Y2tldDpcXHMqL2ksICcnKVxuICAgIC5yZXBsYWNlKC9eXCIrfFwiKyQvZywgJycpXG4gICAgLnJlcGxhY2UoL14nK3wnKyQvZywgJycpXG4gICAgLnJlcGxhY2UoL15cXC8rfFxcLyskL2csICcnKTtcblxuICBjb25zdCBjbGVhbktleSA9IGFzc2V0LmtleVxuICAgID8ucmVwbGFjZSgvXmtleTpcXHMqL2ksICcnKVxuICAgIC5yZXBsYWNlKC9eXCIrfFwiKyQvZywgJycpXG4gICAgLnJlcGxhY2UoL14nK3wnKyQvZywgJycpXG4gICAgLnJlcGxhY2UoLywrJC9nLCAnJylcbiAgICAudHJpbSgpO1xuXG4gIGNvbnN0IGNsZWFuUGF0aCA9IG5vcm1hbGl6ZVN0b3JhZ2VQYXRoKGFzc2V0LmZpbGVfcGF0aCwgY2xlYW5CdWNrZXQpO1xuICBjb25zdCBmaXhDbGllbnRzUGF0aCA9IChwYXRoPzogc3RyaW5nIHwgbnVsbCkgPT4ge1xuICAgIGlmICghcGF0aCkgcmV0dXJuIHBhdGg7XG4gICAgLy8gQ2Fzb3MgaW1wb3J0YWRvcyBjb20gcHJlZml4byBkdXBsaWNhZG8gXCJjbGllbnRzLmNsaWVudHMuc3RyaXAuWC5zdmdcIlxuICAgIGlmICgvXmNsaWVudHNcXC5jbGllbnRzXFwuc3RyaXBcXC4vLnRlc3QocGF0aCkpIHtcbiAgICAgIHJldHVybiBwYXRoLnJlcGxhY2UoXG4gICAgICAgIC9eY2xpZW50c1xcLmNsaWVudHNcXC5zdHJpcFxcLi8sXG4gICAgICAgICdjbGllbnRzL2NsaWVudHMuc3RyaXAuJ1xuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKC9eY2xpZW50c1xcLnN0cmlwXFwuLy50ZXN0KHBhdGgpKSB7XG4gICAgICByZXR1cm4gcGF0aC5yZXBsYWNlKC9eY2xpZW50c1xcLnN0cmlwXFwuLywgJ2NsaWVudHMvY2xpZW50cy5zdHJpcC4nKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhdGg7XG4gIH07XG4gIGNvbnN0IHJlc29sdmVkUGF0aCA9IGZpeENsaWVudHNQYXRoKGNsZWFuUGF0aCk7XG5cbiAgLy8gQ29ycmlnZSBidWNrZXQgcGFyYSBtZWRpYSBkZSBwb3J0ZsOzbGlvIHF1ZSBmb3JhbSBpbXBvcnRhZGFzIGNvbSBvIGJ1Y2tldCBlcnJhZG9cbiAgY29uc3QgcmVzb2x2ZWRCdWNrZXQgPVxuICAgIGNsZWFuQnVja2V0ID09PSAnc2l0ZS1hc3NldHMnICYmIHJlc29sdmVkUGF0aD8uc3RhcnRzV2l0aCgncHJvamVjdHMvJylcbiAgICAgID8gJ3BvcnRmb2xpby1tZWRpYSdcbiAgICAgIDogY2xlYW5CdWNrZXQ7XG5cbiAgY29uc3QgaW5mZXJQYWdlRnJvbVZhbHVlID0gKHZhbHVlPzogc3RyaW5nIHwgbnVsbCkgPT4ge1xuICAgIGlmICghdmFsdWUpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgY29uc3QgdHJpbW1lZCA9IHZhbHVlXG4gICAgICAucmVwbGFjZSgvXnBhZ2U6XFxzKi9pLCAnJylcbiAgICAgIC5yZXBsYWNlKC9eXCIrfFwiKyQvZywgJycpXG4gICAgICAucmVwbGFjZSgvXicrfCcrJC9nLCAnJylcbiAgICAgIC5yZXBsYWNlKC8sKyQvZywgJycpXG4gICAgICAudHJpbSgpO1xuICAgIGlmICghdHJpbW1lZCkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICBpZiAoL151cGRhdGVkX2F0Oi9pLnRlc3QodHJpbW1lZCkgfHwgL15rZXk6L2kudGVzdCh0cmltbWVkKSlcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgY29uc3QgZGVsaW1pdGVyID0gdHJpbW1lZC5pbmNsdWRlcygnLycpID8gJy8nIDogJy4nO1xuICAgIGNvbnN0IGJhc2UgPSB0cmltbWVkLnNwbGl0KGRlbGltaXRlcilbMF07XG4gICAgcmV0dXJuIGJhc2U/LnRvTG93ZXJDYXNlKCk7XG4gIH07XG5cbiAgY29uc3QgcmVzb2x2ZWRQYWdlID1cbiAgICBpbmZlclBhZ2VGcm9tVmFsdWUoYXNzZXQucGFnZSkgfHxcbiAgICBpbmZlclBhZ2VGcm9tVmFsdWUocmVzb2x2ZWRQYXRoKSB8fFxuICAgIGluZmVyUGFnZUZyb21WYWx1ZShjbGVhbktleSkgfHxcbiAgICAnZ2xvYmFsJztcblxuICBjb25zdCBwdWJsaWNVcmwgPVxuICAgIGJ1aWxkU3VwYWJhc2VTdG9yYWdlVXJsKHJlc29sdmVkQnVja2V0LCByZXNvbHZlZFBhdGgpIHx8XG4gICAgKGFzc2V0LmZpbGVfcGF0aD8uc3RhcnRzV2l0aCgnaHR0cCcpID8gYXNzZXQuZmlsZV9wYXRoIDogJycpIHx8XG4gICAgJyc7XG5cbiAgLy8gUHJvY2Vzc2FyIGhyZWYgc2UgZXhpc3RpclxuICBsZXQgcHJvY2Vzc2VkQXNzZXQ6IE5vcm1hbGl6ZWRTaXRlQXNzZXQgPSB7XG4gICAgLi4uYXNzZXQsXG4gICAga2V5OiBjbGVhbktleSA/PyBhc3NldC5rZXksXG4gICAgYnVja2V0OiByZXNvbHZlZEJ1Y2tldCxcbiAgICBmaWxlX3BhdGg6IGNsZWFuUGF0aCA/PyAnJyxcbiAgICBwYWdlOiByZXNvbHZlZFBhZ2UsXG4gICAgcmVzb2x2ZWRQYWdlLFxuICAgIHB1YmxpY1VybCxcbiAgfTtcblxuICBpZiAoYXNzZXQuaHJlZikge1xuICAgIGNvbnN0IHZhbGlkYXRlZEhyZWYgPSB2YWxpZGF0ZUV4dGVybmFsVXJsKGFzc2V0LmhyZWYpO1xuICAgIGlmICh2YWxpZGF0ZWRIcmVmKSB7XG4gICAgICBwcm9jZXNzZWRBc3NldCA9IHtcbiAgICAgICAgLi4ucHJvY2Vzc2VkQXNzZXQsXG4gICAgICAgIGhyZWY6IHZhbGlkYXRlZEhyZWYsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBwcm9jZXNzZWRBc3NldDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZUFzc2V0TGlzdChcbiAgYXNzZXRzOiBEYkFzc2V0W10sXG4gIG9wdGlvbnM6IHsgb25seUFjdGl2ZT86IGJvb2xlYW47IGRyb3BJbnZhbGlkPzogYm9vbGVhbiB9ID0ge31cbikge1xuICBjb25zdCB7IG9ubHlBY3RpdmUgPSBmYWxzZSwgZHJvcEludmFsaWQgPSB0cnVlIH0gPSBvcHRpb25zO1xuICBjb25zdCBub3JtYWxpemVkQnlLZXkgPSBuZXcgTWFwPHN0cmluZywgTm9ybWFsaXplZFNpdGVBc3NldD4oKTtcbiAgY29uc3Qgbm9ybWFsaXplZEJ5UGF0aCA9IG5ldyBNYXA8c3RyaW5nLCBOb3JtYWxpemVkU2l0ZUFzc2V0PigpO1xuXG4gIGNvbnN0IGlzSW52YWxpZFZhbHVlID0gKHZhbHVlPzogc3RyaW5nIHwgbnVsbCkgPT4ge1xuICAgIGlmICghdmFsdWUpIHJldHVybiB0cnVlO1xuICAgIGNvbnN0IG5vcm1hbGl6ZWRWYWx1ZSA9IHZhbHVlLnRyaW0oKS50b0xvd2VyQ2FzZSgpO1xuICAgIGlmICghbm9ybWFsaXplZFZhbHVlKSByZXR1cm4gdHJ1ZTtcbiAgICByZXR1cm4gKFxuICAgICAgbm9ybWFsaXplZFZhbHVlLnN0YXJ0c1dpdGgoJ3VwZGF0ZWRfYXQ6JykgfHxcbiAgICAgIG5vcm1hbGl6ZWRWYWx1ZS5zdGFydHNXaXRoKCdrZXk6JykgfHxcbiAgICAgIG5vcm1hbGl6ZWRWYWx1ZS5zdGFydHNXaXRoKCdmaWxlX3BhdGg6JykgfHxcbiAgICAgIG5vcm1hbGl6ZWRWYWx1ZSA9PT0gJy5rZWVwJyB8fFxuICAgICAgbm9ybWFsaXplZFZhbHVlID09PSAnLmVtcHR5Zm9sZGVycGxhY2Vob2xkZXInXG4gICAgKTtcbiAgfTtcblxuICBjb25zdCBkZWR1cGVEb3VibGVQcmVmaXggPSAodmFsdWU/OiBzdHJpbmcgfCBudWxsKSA9PiB7XG4gICAgaWYgKCF2YWx1ZSkgcmV0dXJuIHZhbHVlO1xuICAgIGNvbnN0IHRyaW1tZWQgPSB2YWx1ZS50cmltKCk7XG4gICAgaWYgKCF0cmltbWVkKSByZXR1cm4gdmFsdWU7XG5cbiAgICBjb25zdCBkZWxpbWl0ZXIgPSB0cmltbWVkLmluY2x1ZGVzKCcvJykgPyAnLycgOiAnLic7XG4gICAgY29uc3QgcGFydHMgPSB0cmltbWVkLnNwbGl0KGRlbGltaXRlcikuZmlsdGVyKEJvb2xlYW4pO1xuICAgIGlmIChwYXJ0cy5sZW5ndGggPCA0KSByZXR1cm4gdmFsdWU7XG5cbiAgICBjb25zdCBtYXhQcmVmaXggPSBNYXRoLm1pbigzLCBNYXRoLmZsb29yKHBhcnRzLmxlbmd0aCAvIDIpKTtcbiAgICBmb3IgKGxldCBsZW4gPSAxOyBsZW4gPD0gbWF4UHJlZml4OyBsZW4rKykge1xuICAgICAgY29uc3QgZmlyc3QgPSBwYXJ0cy5zbGljZSgwLCBsZW4pLmpvaW4oJ3wnKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgY29uc3Qgc2Vjb25kID0gcGFydHNcbiAgICAgICAgLnNsaWNlKGxlbiwgbGVuICogMilcbiAgICAgICAgLmpvaW4oJ3wnKVxuICAgICAgICAudG9Mb3dlckNhc2UoKTtcbiAgICAgIGlmIChmaXJzdCA9PT0gc2Vjb25kKSB7XG4gICAgICAgIGNvbnN0IGRlZHVwZWQgPSBbLi4ucGFydHMuc2xpY2UoMCwgbGVuKSwgLi4ucGFydHMuc2xpY2UobGVuICogMildO1xuICAgICAgICByZXR1cm4gZGVkdXBlZC5qb2luKGRlbGltaXRlcik7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbiAgfTtcblxuICBjb25zdCBzY29yZVJlY29yZCA9IChyZWNvcmQ6IE5vcm1hbGl6ZWRTaXRlQXNzZXQpID0+IHtcbiAgICBjb25zdCBhY3RpdmVTY29yZSA9IHJlY29yZC5pc19hY3RpdmUgPyA0IDogMDtcbiAgICBjb25zdCB1cmxTY29yZSA9IHJlY29yZC5wdWJsaWNVcmwgPyAyIDogMDtcbiAgICBjb25zdCBwYXRoU2NvcmUgPSByZWNvcmQuZmlsZV9wYXRoPy5pbmNsdWRlcygnLycpID8gMSA6IDA7XG4gICAgY29uc3QgbGVuZ3RoUGVuYWx0eSA9IE1hdGgubWluKHJlY29yZC5rZXk/Lmxlbmd0aCA/PyAwLCA2MCkgKiAwLjAxO1xuICAgIHJldHVybiBhY3RpdmVTY29yZSArIHVybFNjb3JlICsgcGF0aFNjb3JlIC0gbGVuZ3RoUGVuYWx0eTtcbiAgfTtcblxuICBmb3IgKGNvbnN0IGFzc2V0IG9mIGFzc2V0cykge1xuICAgIGNvbnN0IGNsZWFuZWRBc3NldDogRGJBc3NldCA9IHtcbiAgICAgIC4uLmFzc2V0LFxuICAgICAga2V5OiBkZWR1cGVEb3VibGVQcmVmaXgoYXNzZXQua2V5KSA/PyBhc3NldC5rZXksXG4gICAgICBmaWxlX3BhdGg6IGRlZHVwZURvdWJsZVByZWZpeChhc3NldC5maWxlX3BhdGgpID8/IGFzc2V0LmZpbGVfcGF0aCxcbiAgICB9O1xuXG4gICAgY29uc3QgcmVjb3JkID0gbm9ybWFsaXplQXNzZXRSZWNvcmQoY2xlYW5lZEFzc2V0KTtcbiAgICBjb25zdCBrZXkgPSByZWNvcmQua2V5Py50cmltKCk7XG4gICAgaWYgKCFrZXkpIGNvbnRpbnVlO1xuXG4gICAgaWYgKGRyb3BJbnZhbGlkKSB7XG4gICAgICBpZiAoaXNJbnZhbGlkVmFsdWUoa2V5KSB8fCBpc0ludmFsaWRWYWx1ZShyZWNvcmQuZmlsZV9wYXRoKSkgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKG9ubHlBY3RpdmUgJiYgIXJlY29yZC5pc19hY3RpdmUpIGNvbnRpbnVlO1xuXG4gICAgY29uc3QgaGFzVXNhYmxlVXJsID0gQm9vbGVhbihcbiAgICAgIHJlY29yZC5wdWJsaWNVcmwgfHwgcmVjb3JkLmFzc2V0X3R5cGUgPT09ICdmb250JyB8fCByZWNvcmQuaHJlZlxuICAgICk7XG4gICAgaWYgKGRyb3BJbnZhbGlkICYmICFoYXNVc2FibGVVcmwpIGNvbnRpbnVlO1xuXG4gICAgY29uc3QgZGVjaWRlID0gKFxuICAgICAgY3VycmVudDogTm9ybWFsaXplZFNpdGVBc3NldCB8IHVuZGVmaW5lZCxcbiAgICAgIG5leHQ6IE5vcm1hbGl6ZWRTaXRlQXNzZXRcbiAgICApID0+IHtcbiAgICAgIGlmICghY3VycmVudCkgcmV0dXJuIG5leHQ7XG4gICAgICBjb25zdCBjdXJyZW50U2NvcmUgPSBzY29yZVJlY29yZChjdXJyZW50KTtcbiAgICAgIGNvbnN0IG5leHRTY29yZSA9IHNjb3JlUmVjb3JkKG5leHQpO1xuICAgICAgaWYgKG5leHRTY29yZSA+IGN1cnJlbnRTY29yZSkgcmV0dXJuIG5leHQ7XG4gICAgICBpZiAobmV4dFNjb3JlID09PSBjdXJyZW50U2NvcmUpIHtcbiAgICAgICAgcmV0dXJuIG5leHQua2V5Lmxlbmd0aCA8IGN1cnJlbnQua2V5Lmxlbmd0aCA/IG5leHQgOiBjdXJyZW50O1xuICAgICAgfVxuICAgICAgcmV0dXJuIGN1cnJlbnQ7XG4gICAgfTtcblxuICAgIGNvbnN0IGJlc3RCeUtleSA9IGRlY2lkZShub3JtYWxpemVkQnlLZXkuZ2V0KGtleSksIHJlY29yZCk7XG4gICAgbm9ybWFsaXplZEJ5S2V5LnNldChrZXksIGJlc3RCeUtleSk7XG5cbiAgICBjb25zdCBwYXRoS2V5ID0gcmVjb3JkLmZpbGVfcGF0aCB8fCAnJztcbiAgICBpZiAocGF0aEtleSkge1xuICAgICAgY29uc3QgYmVzdEJ5UGF0aCA9IGRlY2lkZShub3JtYWxpemVkQnlQYXRoLmdldChwYXRoS2V5KSwgcmVjb3JkKTtcbiAgICAgIG5vcm1hbGl6ZWRCeVBhdGguc2V0KHBhdGhLZXksIGJlc3RCeVBhdGgpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IG1lcmdlZCA9IG5ldyBNYXA8c3RyaW5nLCBOb3JtYWxpemVkU2l0ZUFzc2V0PigpO1xuICBmb3IgKGNvbnN0IGl0ZW0gb2Ygbm9ybWFsaXplZEJ5S2V5LnZhbHVlcygpKSB7XG4gICAgbWVyZ2VkLnNldChpdGVtLmlkLCBpdGVtKTtcbiAgfVxuICBmb3IgKGNvbnN0IGl0ZW0gb2Ygbm9ybWFsaXplZEJ5UGF0aC52YWx1ZXMoKSkge1xuICAgIG1lcmdlZC5zZXQoaXRlbS5pZCwgaXRlbSk7XG4gIH1cblxuICByZXR1cm4gQXJyYXkuZnJvbShtZXJnZWQudmFsdWVzKCkpLnNvcnQoKGEsIGIpID0+IHtcbiAgICBjb25zdCBwYWdlQSA9IGEucGFnZSA/PyAnJztcbiAgICBjb25zdCBwYWdlQiA9IGIucGFnZSA/PyAnJztcbiAgICBpZiAocGFnZUEgPT09IHBhZ2VCKSB7XG4gICAgICBjb25zdCBvcmRlckEgPSBhLnNvcnRfb3JkZXIgPz8gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVI7XG4gICAgICBjb25zdCBvcmRlckIgPSBiLnNvcnRfb3JkZXIgPz8gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVI7XG4gICAgICBpZiAob3JkZXJBID09PSBvcmRlckIpIHJldHVybiBhLmtleS5sb2NhbGVDb21wYXJlKGIua2V5KTtcbiAgICAgIHJldHVybiBvcmRlckEgLSBvcmRlckI7XG4gICAgfVxuICAgIHJldHVybiBwYWdlQS5sb2NhbGVDb21wYXJlKHBhZ2VCKTtcbiAgfSk7XG59XG4iXSwidmVyc2lvbiI6M30=